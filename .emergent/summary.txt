<analysis>**original_problem_statement:**
The user initially requested reusable code for UI components. The scope then expanded to a full PWA with offline data collection (FieldForce app), enumerator interfaces, supervisor tools, and an onboarding wizard.

In this session, the user asked to:
1.  Implement a new, feature-rich  they provided.
2.  Fix and enhance the sharing functionality on the Collection Links page.
3.  Add the same enhanced sharing functionality to the main Forms page.
4.  The latest request from the user is to add a CSV/Excel import for enumerators, integrate a link shortener, and allow custom message templates for sharing.

PRODUCT REQUIREMENTS:
-   A fully functional dashboard header with Global Search (âŒ˜K), Notifications, and a Language Selector.
-   A robust and user-friendly sharing mechanism for both collection links and surveys, including options for WhatsApp, Email, SMS, QR Code, and direct link copying.
-   Project context to be visible on the Collection Links page.
-   (New) Bulk enumerator import via CSV/Excel files.
-   (New) Integration with a link-shortening service.
-   (New) Customizable message templates for sharing links.

**User's preferred language**: English

**what currently exists?**
The FieldForce application is a full-stack PWA (React/FastAPI/MongoDB) with offline data collection capabilities. It features:
-   Full user authentication and project/form management.
-   A new, fully functional dashboard header with a  global search palette, a notifications panel, and a language selector.
-   A Collection Links management page for supervisors with a 3-dots action menu offering enhanced sharing options (WhatsApp, Email, SMS, QR Code, Copy Link) and project context in the table.
-   The main Forms dashboard now also includes the same 3-dots action menu with a share submenu on each form card.
-   Two data collection flows: a login-based one for internal teams () and a token-based one for external enumerators ().

**Last working item**:
-   **Last item agent was working:** Implementing the enhanced 3-dots share menu on the main Forms page, adding a submenu with options for Copy Link, QR Code, WhatsApp, Email, and SMS.
-   **Status:** USER VERIFICATION PENDING
-   **Agent Testing Done:** Y
-   **Which testing method agent to use?** NA (Work is complete, awaiting user feedback or proceeding to next tasks).
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1: (P0) Unstable User Session.** The agent experienced repeated, frequent logouts during testing with the . Each tool call seemed to start a new, unauthenticated session. This is a critical blocker for both development and user experience.

Issues Detail:
-   **Issue 1: Unstable User Session**
    -   **Attempted fixes:** The agent worked around the issue by combining multiple test steps into single, long  scripts, but did not investigate or fix the root cause.
    -   **Next debug checklist:**
        1.  Examine  and any related auth hooks. Verify how the authentication token is stored (e.g., , , in-memory). It should be in  for persistence.
        2.  Check the Axios instance configuration. Ensure the  header is correctly and consistently applied to all API requests after login.
        3.  Review the  dependency in  to ensure it's not failing silently under certain conditions.
        4.  Run a simple test: log in, refresh the page, and make an authenticated API call via the browser's developer console to see if the session persists.
    -   **Why fix this issue and what will be achieved with the fix?** A stable session is fundamental for a usable application. Fixing this will unblock reliable testing and provide a normal user experience.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Both
    -   **Blocked on other issue:** None. This is a blocker for other tasks.

**In progress Task List**:
None.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **(P1) Add Enumerator Import:** Implement functionality to import enumerators from CSV and Excel files. This will likely require a new UI component and backend endpoints for file parsing and user/token creation.
    -   **(P1) Integrate Link Shortener:** Integrate a third-party link shortening service. The agent **must** use the  tool for this.
    -   **(P2) Custom Message Templates:** Create a feature that allows supervisors to define and use custom message templates for the WhatsApp, Email, and SMS share options.
-   **Future Tasks:**
    -   **Auto-open single-form surveys:** If a collection token link contains only one form, automatically redirect the enumerator to the form-filling page.
    -   **Full Theming:** Refactor  and  to use theme-aware CSS variables for light/dark mode consistency.
    -   **Component Refactoring:** Break down the large  into smaller, more maintainable child components.

**Completed work in this session**
-   **Dashboard Header Overhaul:** Implemented a new, fully functional dashboard header with a Global Search () Command Palette, a Notifications Panel, and a Language Selector.
-   **Reusable Code Delivery:** Provided the complete, reusable code for the entire data collection flow as requested by the user.
-   **Enhanced Collection Links Sharing:** Upgraded the Collection Links page with a 3-dots action menu, advanced share options (WhatsApp, Email, SMS, QR), and added a Project column for context.
-   **Enhanced Forms Page Sharing:** Implemented the same advanced 3-dots share submenu on the main Forms page for each survey card.

**Earlier issues found/mentioned but not fixed**
None.

**Known issue recurrence from previous fork**
None.

**Code Architecture**


**Key Technical Concepts**
-   **Frontend:** React, Vite, Tailwind CSS, Shadcn/ui, Zustand, Axios, Framer Motion.
-   **Backend:** FastAPI, Python.
-   **Database:** MongoDB.
-   **PWA:** Service Workers, .
-   **Offline:** IndexedDB.
-   **New Libraries:**  for the command palette.

**key DB schema**
-   **collection_tokens:** Modified. Now stores the  itself alongside the  to enable the share later functionality.

**changes in tech stack**
-   Added  dependency for the global search command palette.

**All files of reference**
*   : New backend for global search.
*   : New backend for notifications.
*   : Modified to include new routers.
*   : New UI for the search palette.
*   : New UI for the notifications dropdown.
*   : New UI for language selection.
*   : Modified to integrate the new header components.
*   : Modified to add the project column and the 3-dots share menu.
*   : Modified to add the 3-dots share menu to form cards.
*   : Modified with the new share submenu logic.
*   : Modified to include more sharing options (WhatsApp, Email, etc.).
*   : Modified to add state for the command palette.

**Areas that need refactoring**:
-    and  still use hardcoded dark theme colors and should be updated to use theme variables.
-   The session persistence logic needs to be investigated and potentially refactored to be more robust (see All Pending/In progress Issue list).

**key api endpoints**
*   : For the global search functionality.
*   : To fetch user notifications.
*   : To mark notifications as read.
*   : (Modified) The response now includes the full token upon creation.

**Critical Info for New Agent**
-   **FIX THE SESSION LOGOUT ISSUE FIRST (P0).** You will be unable to test reliably until the user session persists between actions. Investigate the auth token storage () and Axios headers immediately.
-   The user's next set of tasks is clearly defined: CSV/Excel import, link shortener integration, and custom message templates.
-   For the Link Shortener task, you **must** use the  subagent to ensure a correct and secure implementation.

**documents and test reports created in this job**
*    was updated.

**Last 10 User Messages and any pending HUMAN messages**
10. **User**: Add CSV/Excel enumerator import and integrate a link shortener with custom message templates. (Pending)
9.  **User**: *[Posts screenshot of forms page]* Do also for share functionality on this page. (Completed)
8.  **Agent**: Provides summary of collection links fixes and asks about scalability. (Completed)
7.  **User**: *[Clicks a 3-dots menu on collection links page]*. (Implicit request to test)
6.  **Agent**: Provides the live URL and instructions. (Completed)
5.  **User**: Share the web link URL. (Completed)
4.  **Agent**: Updates PRD.md and calls finish tool. (Interrupted by user message)
3.  **User**: On Collection Link - When you click share the link is not copies - Why not have multople options like and also how do you knwo which project do the links belong to? What if there are over 500 enumeators What is another way to implement this which is quicker - by using login is it there? Is the present approach the token approach. (Addressed and implemented)
2.  **User**: For sharev- use the 3 dots and re-use the code below *[pastes ShareSurveyDialog code]*. (Addressed and implemented)
1.  **User**: 1. Fully functional 2. Yes. (Confirmation to implement the new Dashboard Header).

**Project Health Check:**
-   **Broken:** User session management. The application frequently logs the user out, making it difficult to use and test.
-   **Mocked:** The interactive demo at .

**3rd Party Integrations**
-   **Requested:** A Link Shortener integration is the next task.

**Testing status**
-   **Testing agent used after significant changes:** NO
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None
-   **Known regressions:** The unstable user session is a major regression in usability.

**Credentials to test flow:**
-   **Email:** 
-   **Password:** 

**What agent forgot to execute**
-   The agent did not fix the root cause of the session logout issue, instead opting for workarounds.
-   A full test run using  was not performed after the significant implementation of the new Dashboard Header and its associated features.</analysis>
